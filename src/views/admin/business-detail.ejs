<%
// Función para formatear los valores del formulario
function formatValue(field, value) {
    const formats = {
        sectorEconomico: {
            'agricultura': 'Agricultura, ganadería y pesca',
            'manufactura': 'Manufactura',
            'comercio': 'Comercio',
            'servicios': 'Servicios',
            'tecnologia': 'Tecnología',
            'turismo': 'Turismo',
            'construccion': 'Construcción',
            'otro': 'Otro'
        },
        tiempoOperacion: {
            '0_6_meses': 'Menos de 6 meses',
            '6_12_meses': '6 a 12 meses',
            '12_24_meses': '1 a 3 años',
            'mas_24_meses': '4 años o más'
        },
        ventasNetas: {
            'menos_1_smmlv': 'Menos de 1 SMMLV',
            '1_3_smmlv': '1 - 3 SMMLV',
            '3_mas_smmlv': '3 o más SMMLV'
        },
        rentabilidad: {
            'menos_medio_smmlv': 'Menos de ½ SMMLV',
            'medio_1_smmlv': '½ y 1 SMMLV',
            '2_mas_smmlv': '2 o más SMMLV'
        },
        fuentesFinanciamiento: {
            'recursos_propios': 'Recursos propios',
            'credito_bancario': 'Crédito bancario',
            'inversionistas': 'Inversionistas',
            'subsidios': 'Subsidios gubernamentales',
            'mixto': 'Mixto'
        },
        costosFijos: {
            'menos_medio_smmlv': 'Menos de ½ SMMLV',
            'medio_1_smmlv': '½ y 1 SMMLV',
            '2_mas_smmlv': '2 o más SMMLV'
        },
        formacionEmpresarial: {
            'sin_formacion': 'Sin formación empresarial',
            'tecnica_profesional': 'Con formación técnica/profesional',
            'administracion_emprendimiento': 'Con formación en administración/emprendimiento'
        }
    };
    
    if (formats[field] && formats[field][value]) {
        return formats[field][value];
    }
    return value;
}
%>
<%- include('../partials/header') %>
<link rel="stylesheet" href="/css/dashboard.css">
<link rel="stylesheet" href="/css/caracterizacion.css">
<style>
    /* Estilos adicionales para la vista del admin */
    .admin-header {
        background: white;
        padding: 20px 30px;
        margin-bottom: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .admin-header h1 {
        margin: 0;
        font-size: 28px;
        color: #333;
    }

    .btn-back {
        background: #6c757d;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-back:hover {
        background: #5a6268;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }

    /* Botón Generar PDF - estilos del sistema, idénticos a dashboard.css */
    .btn-generar-pdf {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        background: #0033ff;
        color: #fff;
        border: 1px solid #0033ff;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background .2s ease, box-shadow .2s ease, transform .05s ease;
        box-shadow: 0 2px 6px rgba(0, 51, 255, 0.18);
    }

    .btn-generar-pdf:hover {
        background: #0026cc;
        border-color: #0026cc;
        box-shadow: 0 4px 10px rgba(0, 51, 255, 0.22);
    }

    .btn-generar-pdf:active {
        background: #001a99;
        border-color: #001a99;
        transform: translateY(0.5px);
    }

    .btn-generar-pdf:disabled {
        opacity: .6;
        cursor: not-allowed;
        box-shadow: none;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    .btn-generar-pdf.loading svg { animation: spin 1s linear infinite; }

    .user-info-card {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .user-info-card h3 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 18px;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
    }

    .user-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }

    .user-info-item {
        display: flex;
        flex-direction: column;
    }

    .user-info-label {
        font-size: 12px;
        color: #666;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    .user-info-value {
        font-size: 16px;
        color: #333;
        font-weight: 500;
    }

    .section-divider {
        margin: 40px 0;
        border: none;
        border-top: 2px solid #e9ecef;
    }

    .section-header {
        background: #667eea;
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        margin: 30px 0 20px 0;
    }

    .section-header h2 {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
    }

    /* Ajustes para el formulario en modo readonly */
    .caracterizacion-container {
        max-width: 100%;
        padding: 0;
    }

    .form-card {
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .form-input:read-only,
    .form-input:disabled,
    .form-textarea:read-only {
        background-color: #f8f9fa;
        cursor: not-allowed;
        color: #495057;
    }

    .dashboard-container {
        max-width: 100%;
    }

    .breadcrumb {
        margin-bottom: 20px;
    }

    @media print {
        .btn-back,
        .admin-header,
        .breadcrumb,
        nav {
            display: none;
        }
    }
</style>
<%- include('../partials/navbar-admin') %>

<!-- Breadcrumb -->
<div class="breadcrumb">
    <span class="breadcrumb-item">> Admin</span>
    <span class="breadcrumb-item">> Emprendimientos</span>
    <span class="breadcrumb-item">> <%= business.name %></span>
</div>

<!-- Header con botón de regreso -->
<div class="admin-header">
    <h1>Detalle del Emprendimiento</h1>
    <div style="display: flex; gap: 10px; align-items: center;">
        <% if (typeof caracterizacion !== "undefined" && caracterizacion) { %>
        <button id="btnGenerarPDFAdmin" class="btn-generar-pdf">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Generar Reporte PDF
        </button>
        <% } %>
        <a href="/admin/emprendimientos" class="btn-back">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Volver a Emprendimientos
        </a>
    </div>
</div>

<!-- Información del Usuario Emprendedor -->
<div class="user-info-card">
    <h3>Información del Emprendedor</h3>
    <div class="user-info-grid">
        <div class="user-info-item">
            <span class="user-info-label">Nombre Completo</span>
            <span class="user-info-value"><%= userData ? `${userData.firstName} ${userData.lastName}` : 'No disponible' %></span>
        </div>
        <div class="user-info-item">
            <span class="user-info-label">Email</span>
            <span class="user-info-value"><%= userData ? userData.email : 'No disponible' %></span>
        </div>
        <div class="user-info-item">
            <span class="user-info-label">Teléfono</span>
            <span class="user-info-value"><%= userData ? userData.phoneContact : 'No disponible' %></span>
        </div>
        <div class="user-info-item">
            <span class="user-info-label">ID de Usuario</span>
            <span class="user-info-value">#<%= userData ? userData.id : 'N/A' %></span>
        </div>
    </div>
</div>

<!-- Sección del Dashboard -->
<div class="section-header">
    <h2>Dashboard de Resultados</h2>
</div>

<div class="dashboard-container">
    <% if (typeof caracterizacion !== "undefined" && caracterizacion) { %>
        
        <!-- Consolidado General -->
        <div class="dashboard-summary">
            <h2>Resumen General</h2>
            <div class="summary-card">
                <div class="summary-item">
                    <div class="summary-icon"></div>
                    <p class="summary-label">Puntaje total</p>
                    <p class="summary-value">
                        <%= caracterizacion.puntajeTotal %> / <%= caracterizacion.maxTotal %>
                    </p>
                </div>
                <div class="summary-item">
                    <div class="summary-icon"></div>
                    <p class="summary-label">Porcentaje</p>
                    <p class="summary-value">
                        <%= caracterizacion.porcentaje %>%
                    </p>
                </div>
                <div class="summary-item">
                    <div class="summary-icon"></div>
                    <p class="summary-label">Clasificación</p>
                    <p class="summary-value status-<%= caracterizacion.estado.toLowerCase().replace(' ', '-') %>">
                        <%= caracterizacion.estado %>
                    </p>
                </div>
            </div>
        </div>

        <!-- Grid Layout para gráfico y progreso -->
        <div class="dashboard-grid">
            <!-- Gráfica de Pastel -->
            <div class="chart-section">
                <h3>Desempeño por Dimensión</h3>
                <div class="chart-container">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>

            <!-- Barra de Progreso y Estadísticas -->
            <div class="progress-section">
                <h3>Nivel de Consolidación</h3>
                <div class="progress-wrapper">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill">
                            <span><%= caracterizacion.porcentaje %>%</span>
                        </div>
                    </div>
                    <div class="progress-stats">
                        <div class="stat-item">
                            <span class="stat-number"><%= caracterizacion.secciones.length %></span>
                            <span class="stat-label">Secciones</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number"><%= Math.round(caracterizacion.secciones.reduce((acc, s) => acc + s.porcentaje, 0) / caracterizacion.secciones.length) %>%</span>
                            <span class="stat-label">Promedio</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Puntajes -->
        <div class="table-section">
            <h3>Detalle por Sección</h3>
            <div class="table-wrapper">
                <table class="score-table">
                    <thead>
                        <tr>
                            <th>Sección</th>
                            <th>Puntaje</th>
                            <th>Porcentaje</th>
                            <th>Progreso</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% caracterizacion.secciones.forEach(sec => { %>
                            <tr>
                                <td><%= sec.nombre %></td>
                                <td><%= sec.puntaje %> / <%= sec.max %></td>
                                <td><%= sec.porcentaje %>%</td>
                                <td>
                                    <div class="mini-progress-bar">
                                        <div class="mini-progress-fill" data-width="<%= sec.porcentaje %>" style="width: 0%;"></div>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>

    <% } else { %>
        <div class="alert alert-warning">
            <p>No hay datos de caracterización disponibles para este emprendimiento.</p>
        </div>
    <% } %>
</div>

<!-- Sección del Formulario de Caracterización -->
<div class="section-header">
    <h2>Formulario de Caracterización</h2>
</div>

<div class="caracterizacion-container">
    <!-- Progress Indicator (Miga de pan de secciones) -->
    <div class="form-progress">
        <div class="progress-step active" data-section="1">
            <div class="step-circle">1</div>
            <div class="step-label">Datos Generales</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" data-section="2">
            <div class="step-circle">2</div>
            <div class="step-label">Modelo de Negocio</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" data-section="3">
            <div class="step-circle">3</div>
            <div class="step-label">Finanzas</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" data-section="4">
            <div class="step-circle">4</div>
            <div class="step-label">Equipo de Trabajo</div>
        </div>
    </div>

    <!-- Formulario Multi-sección (READONLY) -->
    <div class="form-card">        
        <form id="caracterizacionForm">
            
            <!-- SECCIÓN A: Datos Generales -->
            <div class="form-section active" data-section="1">
                <h2 class="section-title">Datos Generales</h2>
                <p class="section-subtitle">Información básica del emprendimiento</p>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="nombreEmprendimiento" class="form-label">Nombre del emprendimiento</label>
                        <input 
                            type="text" 
                            id="nombreEmprendimiento" 
                            name="nombreEmprendimiento" 
                            class="form-input"
                            value="<%= formData.nombreEmprendimiento %>"
                            readonly
                        >
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="anioCreacion" class="form-label">Año de creación del emprendimiento</label>
                        <input 
                            type="number" 
                            id="anioCreacion" 
                            name="anioCreacion" 
                            class="form-input"
                            value="<%= formData.anioCreacion %>"
                            readonly
                        >
                    </div>
                    <div class="form-group">
                        <label for="sectorEconomico" class="form-label">Sector económico</label>
                        <input 
                            type="text" 
                            id="sectorEconomico" 
                            class="form-input"
                            value="<%= formatValue('sectorEconomico', formData.sectorEconomico) %>"
                            readonly
                        >
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="nombreEncargado" class="form-label">Nombre del encargado</label>
                        <input 
                            type="text" 
                            id="nombreEncargado" 
                            name="nombreEncargado" 
                            class="form-input"
                            value="<%= formData.nombreEncargado %>"
                            readonly
                        >
                    </div>
                    <div class="form-group">
                        <label for="celularEncargado" class="form-label">Celular</label>
                        <input 
                            type="tel" 
                            id="celularEncargado" 
                            name="celularEncargado" 
                            class="form-input"
                            value="<%= formData.celularEncargado %>"
                            readonly
                        >
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="correoEncargado" class="form-label">Correo electrónico</label>
                        <input 
                            type="email" 
                            id="correoEncargado" 
                            name="correoEncargado" 
                            class="form-input"
                            value="<%= formData.correoEncargado %>"
                            readonly
                        >
                    </div>
                    <div class="form-group">
                        <label for="tiempoOperacion" class="form-label">Tiempo de operación</label>
                        <input 
                            type="text" 
                            id="tiempoOperacion" 
                            class="form-input"
                            value="<%= formatValue('tiempoOperacion', formData.tiempoOperacion) %>"
                            readonly
                        >
                    </div>
                </div>
            </div>

            <!-- SECCIÓN B: Modelo de Negocio -->
            <div class="form-section" data-section="2">
                <h2 class="section-title">Modelo de Negocio</h2>
                <p class="section-subtitle">Elementos clave del modelo de negocio</p>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="propuestaValor" class="form-label">Propuesta de valor</label>
                        <textarea 
                            id="propuestaValor" 
                            name="propuestaValor" 
                            class="form-textarea"
                            rows="4"
                            readonly
                        ><%= formData.propuestaValor %></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="segmentoClientes" class="form-label">Segmento de clientes</label>
                        <textarea 
                            id="segmentoClientes" 
                            name="segmentoClientes" 
                            class="form-textarea"
                            rows="4"
                            readonly
                        ><%= formData.segmentoClientes %></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="canalesVenta" class="form-label">Canales de venta</label>
                        <textarea 
                            id="canalesVenta" 
                            name="canalesVenta" 
                            class="form-textarea"
                            rows="4"
                            readonly
                        ><%= formData.canalesVenta %></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="fuentesIngreso" class="form-label">Fuentes de ingreso</label>
                        <textarea 
                            id="fuentesIngreso" 
                            name="fuentesIngreso" 
                            class="form-textarea"
                            rows="4"
                            readonly
                        ><%= formData.fuentesIngreso %></textarea>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN C: Finanzas -->
            <div class="form-section" data-section="3">
                <h2 class="section-title">Finanzas</h2>
                <p class="section-subtitle">Información financiera del emprendimiento</p>

                <div class="form-row">
                    <div class="form-group">
                        <label for="ventasNetas" class="form-label">Ventas netas promedio al mes</label>
                        <input 
                            type="text" 
                            id="ventasNetas" 
                            class="form-input"
                            value="<%= formatValue('ventasNetas', formData.ventasNetas) %>"
                            readonly
                        >
                    </div>
                    <div class="form-group">
                        <label for="rentabilidad" class="form-label">Rentabilidad mensual aproximada</label>
                        <input 
                            type="text" 
                            id="rentabilidad" 
                            class="form-input"
                            value="<%= formatValue('rentabilidad', formData.rentabilidad) %>"
                            readonly
                        >
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fuentesFinanciamiento" class="form-label">Fuentes de financiamiento</label>
                        <input 
                            type="text" 
                            id="fuentesFinanciamiento" 
                            class="form-input"
                            value="<%= formatValue('fuentesFinanciamiento', formData.fuentesFinanciamiento) %>"
                            readonly
                        >
                    </div>
                    <div class="form-group">
                        <label for="costosFijos" class="form-label">Costos fijos mensuales</label>
                        <input 
                            type="text" 
                            id="costosFijos" 
                            class="form-input"
                            value="<%= formatValue('costosFijos', formData.costosFijos) %>"
                            readonly
                        >
                    </div>
                </div>
            </div>

            <!-- SECCIÓN D: Equipo de Trabajo -->
            <div class="form-section" data-section="4">
                <h2 class="section-title">Equipo de Trabajo</h2>
                <p class="section-subtitle">Información sobre el equipo y su capacitación</p>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="formacionEmpresarial" class="form-label">Nivel de formación empresarial</label>
                        <input 
                            type="text" 
                            id="formacionEmpresarial" 
                            class="form-input"
                            value="<%= formatValue('formacionEmpresarial', formData.formacionEmpresarial) %>"
                            readonly
                        >
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="personalCapacitado" class="form-label">¿Personal capacitado?</label>
                        <input 
                            type="text" 
                            id="personalCapacitado" 
                            class="form-input"
                            value="<%= formData.personalCapacitado === 'si' ? 'Sí' : 'No' %>"
                            readonly
                        >
                    </div>
                    <div class="form-group">
                        <label for="rolesDefinidos" class="form-label">¿Roles definidos en el emprendimiento?</label>
                        <input 
                            type="text" 
                            id="rolesDefinidos" 
                            class="form-input"
                            value="<%= formData.rolesDefinidos === 'si' ? 'Sí' : 'No' %>"
                            readonly
                        >
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="cantidadEmpleados" class="form-label">Cantidad de empleados</label>
                        <input 
                            type="number" 
                            id="cantidadEmpleados" 
                            name="cantidadEmpleados" 
                            class="form-input"
                            value="<%= formData.cantidadEmpleados %>"
                            readonly
                        >
                    </div>
                </div>
            </div>

            <!-- Botones de Navegación -->
            <div class="form-navigation">
                <button type="button" class="btn-navigation btn-prev" id="btnPrev" style="display: none;">
                    Anterior
                </button>
                <button type="button" class="btn-navigation btn-next" id="btnNext">
                    Siguiente
                </button>
            </div>
        </form>
    </div>
</div>

<%- include('../partials/footer') %>

<!-- Scripts para Dashboard -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<% if (typeof caracterizacion !== "undefined" && caracterizacion) { %>
<script id="caracterizacion-data" type="application/json"><%- JSON.stringify(caracterizacion) %></script>
<% } %>

<script>
(function(){
  const dataScript = document.getElementById('caracterizacion-data');
  if (!dataScript) return;
  const caracterizacion = JSON.parse(dataScript.textContent);

  // Función para animar elementos con delay
  const animateWithDelay = (callback, delay = 500) => {
    setTimeout(callback, delay);
  };

  // Actualizar barra de progreso principal
  const fill = document.getElementById('progressFill');
  if (fill && typeof caracterizacion.porcentaje === 'number') {
    animateWithDelay(() => {
      fill.style.width = `${caracterizacion.porcentaje}%`;
    }, 800);
  }

  // Actualizar barras de progreso mini en la tabla
  const miniProgressBars = document.querySelectorAll('.mini-progress-fill');
  miniProgressBars.forEach((bar, index) => {
    const width = bar.getAttribute('data-width');
    if (width) {
      animateWithDelay(() => {
        bar.style.width = `${width}%`;
      }, 1000 + (index * 100));
    }
  });

  // Gráfico de pastel
  const ctx = document.getElementById('radarChart');
  if (!ctx) return;
  const labels = caracterizacion.secciones.map(s => s.nombre);
  const values = caracterizacion.secciones.map(s => (
    typeof s.porcentaje === 'number' ? s.porcentaje : Math.round((s.puntaje / (s.max || 1)) * 100)
  ));
  const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#84cc16'];

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        label: 'Porcentaje por Sección',
        data: values,
        backgroundColor: colors.slice(0, labels.length),
        borderWidth: 3,
        borderColor: '#ffffff',
        hoverBorderWidth: 4,
        hoverBorderColor: '#ffffff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      cutout: '60%',
      plugins: {
        legend: { 
          position: 'bottom',
          labels: {
            padding: 20,
            font: { size: 14, family: "'Poppins', sans-serif" },
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          padding: 12,
          cornerRadius: 8,
          titleFont: { size: 14, family: "'Poppins', sans-serif" },
          bodyFont: { size: 13, family: "'Poppins', sans-serif" },
          callbacks: {
            label: function(context) {
              return `${context.label}: ${context.parsed}%`;
            }
          }
        }
      },
      animation: {
        animateScale: true,
        animateRotate: true,
        duration: 1500,
        easing: 'easeInOutCubic'
      },
      elements: {
        arc: {
          borderWidth: 3
        }
      }
    }
  });
})();
</script>

<!-- Scripts para navegación del formulario -->
<script>
let currentSection = 1;
const totalSections = 4;

function showSection(sectionNumber) {
    // Ocultar todas las secciones
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Mostrar sección actual
    const currentSectionEl = document.querySelector(`.form-section[data-section="${sectionNumber}"]`);
    if (currentSectionEl) {
        currentSectionEl.classList.add('active');
    }
    
    // Actualizar indicador de progreso
    document.querySelectorAll('.progress-step').forEach(step => {
        const stepSection = parseInt(step.dataset.section);
        step.classList.remove('active', 'completed');
        
        if (stepSection === sectionNumber) {
            step.classList.add('active');
        } else if (stepSection < sectionNumber) {
            step.classList.add('completed');
        }
    });
    
    // Actualizar botones
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    
    btnPrev.style.display = sectionNumber === 1 ? 'none' : 'inline-block';
    btnNext.style.display = sectionNumber === totalSections ? 'none' : 'inline-block';
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Event listeners para navegación
document.getElementById('btnNext').addEventListener('click', function() {
    if (currentSection < totalSections) {
        currentSection++;
        showSection(currentSection);
    }
});

document.getElementById('btnPrev').addEventListener('click', function() {
    if (currentSection > 1) {
        currentSection--;
        showSection(currentSection);
    }
});

// Click en los pasos del progreso
document.querySelectorAll('.progress-step').forEach(step => {
    step.addEventListener('click', function() {
        const targetSection = parseInt(this.dataset.section);
        currentSection = targetSection;
        showSection(currentSection);
    });
});
</script>

<!-- Script para generar PDF del administrador -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnGenerarPDFAdmin = document.getElementById('btnGenerarPDFAdmin');
    
    if (btnGenerarPDFAdmin) {
        btnGenerarPDFAdmin.addEventListener('click', async function() {
            const originalHTML = this.innerHTML;
            const businessId = '<%= business.id %>';
            
            try {
                // Deshabilitar botón y mostrar loading
                this.disabled = true;
                this.classList.add('loading');
                this.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                    Generando Reporte...
                `;

                // Realizar la petición
                const response = await fetch(`/admin/emprendimientos/${businessId}/generar-pdf`);
                
                if (!response.ok) {
                    throw new Error('Error al generar el reporte');
                }

                // Obtener el blob del PDF
                const blob = await response.blob();
                
                // Crear un enlace temporal y descargarlo
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `evaluacion-<%= business.name.replace(/\s+/g, '-') %>-${new Date().getTime()}.pdf`;
                document.body.appendChild(a);
                a.click();
                
                // Limpiar
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // Mostrar mensaje de éxito
                this.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    ¡Descargado!
                `;

                // Mostrar SweetAlert de éxito
                Swal.fire({
                    icon: 'success',
                    title: '¡PDF Generado!',
                    text: 'El reporte ha sido descargado exitosamente',
                    timer: 2000,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });

                setTimeout(() => {
                    this.innerHTML = originalHTML;
                    this.classList.remove('loading');
                    this.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Error:', error);
                
                // Mostrar mensaje de error
                this.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    Error al generar
                `;

                setTimeout(() => {
                    this.innerHTML = originalHTML;
                    this.classList.remove('loading');
                    this.disabled = false;
                }, 2000);

                // Mostrar SweetAlert de error
                Swal.fire({
                    icon: 'error',
                    title: 'Error al generar PDF',
                    text: 'Ocurrió un error al generar el reporte. Por favor, intenta nuevamente.',
                    confirmButtonColor: '#667eea',
                    confirmButtonText: 'Entendido'
                });
            }
        });
    }
});
</script>
