<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<!-- Breadcrumb -->
<div class="breadcrumb">
    <span class="breadcrumb-item">> Caracterización</span>
</div>

<div class="caracterizacion-container">
    <!-- Progress Indicator (Miga de pan de secciones) -->
    <div class="form-progress">
        <div class="progress-step active" data-section="1">
            <div class="step-circle">1</div>
            <div class="step-label">Datos Generales</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" data-section="2">
            <div class="step-circle">2</div>
            <div class="step-label">Modelo de Negocio</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" data-section="3">
            <div class="step-circle">3</div>
            <div class="step-label">Finanzas</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" data-section="4">
            <div class="step-circle">4</div>
            <div class="step-label">Equipo de Trabajo</div>
        </div>
    </div>

    <!-- Formulario Multi-sección -->
    <div class="form-card">
        <form id="caracterizacionForm" method="POST" action="/caracterizacion/guardar">
            
            <!-- SECCIÓN A: Datos Generales -->
            <div class="form-section active" data-section="1">
                <h2 class="section-title">Datos Generales</h2>
                <p class="section-subtitle">Complete el formulario para crear una caracterización</p>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="nombreEmprendimiento" class="form-label">Nombre del emprendimiento</label>
                        <input 
                            type="text" 
                            id="nombreEmprendimiento" 
                            name="nombreEmprendimiento" 
                            class="form-input"
                            required
                        >
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="anioCreacion" class="form-label">Año de creación del emprendimiento</label>
                        <input 
                            type="number" 
                            id="anioCreacion" 
                            name="anioCreacion" 
                            class="form-input"
                            min="1900"
                            max="2025"
                            required
                        >
                        <span class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="sectorEconomico" class="form-label">Sector económico</label>
                        <select id="sectorEconomico" name="sectorEconomico" class="form-input" required>
                            <option value="">Seleccione un sector</option>
                            <option value="agricultura">Agricultura, ganadería y pesca</option>
                            <option value="manufactura">Manufactura</option>
                            <option value="comercio">Comercio</option>
                            <option value="servicios">Servicios</option>
                            <option value="tecnologia">Tecnología</option>
                            <option value="turismo">Turismo</option>
                            <option value="construccion">Construcción</option>
                            <option value="otro">Otro</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="nombreEncargado" class="form-label">Nombre del encargado</label>
                        <input 
                            type="text" 
                            id="nombreEncargado" 
                            name="nombreEncargado" 
                            class="form-input"
                            required
                        >
                        <span class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="celularEncargado" class="form-label">Celular</label>
                        <input 
                            type="tel" 
                            id="celularEncargado" 
                            name="celularEncargado" 
                            class="form-input"
                            placeholder="3001234567"
                            maxlength="10"
                            pattern="[3][0-9]{9}"
                            required
                        >
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="correoEncargado" class="form-label">Correo electrónico</label>
                        <input 
                            type="email" 
                            id="correoEncargado" 
                            name="correoEncargado" 
                            class="form-input"
                            placeholder="ejemplo@correo.com"
                            required
                        >
                        <span class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="tiempoOperacion" class="form-label">Tiempo de operación</label>
                        <select id="tiempoOperacion" name="tiempoOperacion" class="form-input" required>
                            <option value="">Seleccione una opción</option>
                            <option value="menos_6_meses">Menos de 6 meses</option>
                            <option value="6_12_meses">6 a 12 meses</option>
                            <option value="1_3_anios">1 a 3 años</option>
                            <option value="4_mas_anios">4 años o más</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN B: Modelo de Negocio -->
            <div class="form-section" data-section="2">
                <h2 class="section-title">Modelo de Negocio</h2>
                <p class="section-subtitle">Describa los elementos clave de su modelo de negocio</p>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="propuestaValor" class="form-label">Propuesta de valor</label>
                        <textarea 
                            id="propuestaValor" 
                            name="propuestaValor" 
                            class="form-textarea"
                            maxlength="300"
                            rows="4"
                            required
                        ></textarea>
                        <div class="char-counter">
                            <span class="current-chars">0</span> / 300 caracteres
                        </div>
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="segmentoClientes" class="form-label">Segmento de clientes</label>
                        <textarea 
                            id="segmentoClientes" 
                            name="segmentoClientes" 
                            class="form-textarea"
                            maxlength="300"
                            rows="4"
                            required
                        ></textarea>
                        <div class="char-counter">
                            <span class="current-chars">0</span> / 300 caracteres
                        </div>
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="canalesVenta" class="form-label">Canales de venta</label>
                        <textarea 
                            id="canalesVenta" 
                            name="canalesVenta" 
                            class="form-textarea"
                            maxlength="300"
                            rows="4"
                            required
                        ></textarea>
                        <div class="char-counter">
                            <span class="current-chars">0</span> / 300 caracteres
                        </div>
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="fuentesIngreso" class="form-label">Fuentes de ingreso</label>
                        <textarea 
                            id="fuentesIngreso" 
                            name="fuentesIngreso" 
                            class="form-textarea"
                            maxlength="300"
                            rows="4"
                            required
                        ></textarea>
                        <div class="char-counter">
                            <span class="current-chars">0</span> / 300 caracteres
                        </div>
                        <span class="error-message"></span>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN C: Finanzas -->
            <div class="form-section" data-section="3">
                <h2 class="section-title">Finanzas</h2>
                <p class="section-subtitle">Información financiera del emprendimiento</p>

                <div class="form-row">
                    <div class="form-group">
                        <label for="ventasNetas" class="form-label">Ventas netas promedio al mes</label>
                        <select id="ventasNetas" name="ventasNetas" class="form-input" required>
                            <option value="">Seleccione una opción</option>
                            <option value="menos_1_smmlv">Menos de 1 SMMLV</option>
                            <option value="1_3_smmlv">1 - 3 SMMLV</option>
                            <option value="3_mas_smmlv">3 o más SMMLV</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="rentabilidad" class="form-label">Rentabilidad mensual aproximada</label>
                        <select id="rentabilidad" name="rentabilidad" class="form-input" required>
                            <option value="">Seleccione una opción</option>
                            <option value="menos_medio_smmlv">Menos de ½ SMMLV</option>
                            <option value="medio_1_smmlv">½ y 1 SMMLV</option>
                            <option value="2_mas_smmlv">2 o más SMMLV</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fuentesFinanciamiento" class="form-label">Fuentes de financiamiento</label>
                        <select id="fuentesFinanciamiento" name="fuentesFinanciamiento" class="form-input" required>
                            <option value="">Seleccione una opción</option>
                            <option value="recursos_propios">Recursos propios</option>
                            <option value="credito_bancario">Crédito bancario</option>
                            <option value="inversionistas">Inversionistas</option>
                            <option value="subsidios">Subsidios gubernamentales</option>
                            <option value="mixto">Mixto</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="costosFijos" class="form-label">Costos fijos mensuales</label>
                        <select id="costosFijos" name="costosFijos" class="form-input" required>
                            <option value="">Seleccione una opción</option>
                            <option value="menos_medio_smmlv">Menos de ½ SMMLV</option>
                            <option value="medio_1_smmlv">½ y 1 SMMLV</option>
                            <option value="2_mas_smmlv">2 o más SMMLV</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN D: Equipo de Trabajo -->
            <div class="form-section" data-section="4">
                <h2 class="section-title">Equipo de Trabajo</h2>
                <p class="section-subtitle">Información sobre el equipo y su capacitación</p>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="formacionEmpresarial" class="form-label">Nivel de formación empresarial</label>
                        <select id="formacionEmpresarial" name="formacionEmpresarial" class="form-input" required>
                            <option value="">Seleccione una opción</option>
                            <option value="sin_formacion">Sin formación empresarial</option>
                            <option value="tecnica_profesional">Con formación técnica/profesional</option>
                            <option value="administracion_emprendimiento">Con formación en administración/emprendimiento</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="personalCapacitado" class="form-label">¿Personal capacitado?</label>
                        <select id="personalCapacitado" name="personalCapacitado" class="form-input" required>
                            <option value="">Seleccione una opción</option>
                            <option value="si">Sí</option>
                            <option value="no">No</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="rolesDefinidos" class="form-label">¿Roles definidos en el emprendimiento?</label>
                        <select id="rolesDefinidos" name="rolesDefinidos" class="form-input" required>
                            <option value="">Seleccione una opción</option>
                            <option value="si">Sí</option>
                            <option value="no">No</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                </div>
            </div>

            <!-- Botones de Navegación -->
            <div class="form-navigation">
                <button type="button" class="btn-navigation btn-prev" id="btnPrev" style="display: none;">
                    Anterior
                </button>
                <button type="button" class="btn-navigation btn-next" id="btnNext">
                    Siguiente
                </button>
                <button type="submit" class="btn-navigation btn-submit" id="btnSubmit" style="display: none;">
                    Enviar Información
                </button>
            </div>
        </form>
    </div>
</div>

<%- include('../partials/footer') %>

<script>
// Estado del formulario
let currentSection = 1;
const totalSections = 4;

// Actualizar contadores de caracteres
document.querySelectorAll('.form-textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
        const counter = this.parentElement.querySelector('.current-chars');
        if (counter) {
            counter.textContent = this.value.length;
        }
    });
});

// Validación de celular (solo números y que empiece con 3)
document.getElementById('celularEncargado').addEventListener('input', function(e) {
    this.value = this.value.replace(/[^0-9]/g, '');
    if (this.value.length > 0 && this.value[0] !== '3') {
        showError(this, 'El celular debe comenzar con 3');
    } else if (this.value.length > 0 && this.value.length < 10) {
        showError(this, 'El celular debe tener 10 dígitos');
    } else {
        clearError(this);
    }
});

// Validación de año
document.getElementById('anioCreacion').addEventListener('input', function(e) {
    const year = parseInt(this.value);
    if (year < 1900) {
        this.value = 1900;
    } else if (year > 2025) {
        this.value = 2025;
    }
    // No permitir números negativos
    if (this.value < 0) {
        this.value = Math.abs(this.value);
    }
});

// Funciones de validación
function showError(input, message) {
    const errorSpan = input.parentElement.querySelector('.error-message');
    if (errorSpan) {
        errorSpan.textContent = message;
        errorSpan.style.display = 'block';
    }
    input.classList.add('input-error');
}

function clearError(input) {
    const errorSpan = input.parentElement.querySelector('.error-message');
    if (errorSpan) {
        errorSpan.textContent = '';
        errorSpan.style.display = 'none';
    }
    input.classList.remove('input-error');
}

function validateSection(sectionNumber) {
    const section = document.querySelector(`.form-section[data-section="${sectionNumber}"]`);
    const inputs = section.querySelectorAll('input[required], select[required], textarea[required]');
    let isValid = true;

    inputs.forEach(input => {
        clearError(input);
        
        if (!input.value.trim()) {
            showError(input, 'Este campo es obligatorio');
            isValid = false;
        } else {
            // Validaciones específicas
            if (input.type === 'email' && !isValidEmail(input.value)) {
                showError(input, 'Correo electrónico inválido');
                isValid = false;
            }
            
            if (input.type === 'tel' && input.value.length !== 10) {
                showError(input, 'El celular debe tener 10 dígitos');
                isValid = false;
            }
            
            if (input.type === 'tel' && !input.value.startsWith('3')) {
                showError(input, 'El celular debe comenzar con 3');
                isValid = false;
            }
        }
    });

    return isValid;
}

function isValidEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

function showSection(sectionNumber) {
    // Ocultar todas las secciones
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Mostrar sección actual
    const currentSectionEl = document.querySelector(`.form-section[data-section="${sectionNumber}"]`);
    if (currentSectionEl) {
        currentSectionEl.classList.add('active');
    }
    
    // Actualizar indicador de progreso
    document.querySelectorAll('.progress-step').forEach(step => {
        const stepSection = parseInt(step.dataset.section);
        step.classList.remove('active', 'completed');
        
        if (stepSection === sectionNumber) {
            step.classList.add('active');
        } else if (stepSection < sectionNumber) {
            step.classList.add('completed');
        }
    });
    
    // Actualizar botones
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnSubmit = document.getElementById('btnSubmit');
    
    btnPrev.style.display = sectionNumber === 1 ? 'none' : 'inline-block';
    btnNext.style.display = sectionNumber === totalSections ? 'none' : 'inline-block';
    btnSubmit.style.display = sectionNumber === totalSections ? 'inline-block' : 'none';
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Event listeners para navegación
document.getElementById('btnNext').addEventListener('click', function() {
    if (validateSection(currentSection)) {
        if (currentSection < totalSections) {
            currentSection++;
            showSection(currentSection);
        }
    }
});

document.getElementById('btnPrev').addEventListener('click', function() {
    if (currentSection > 1) {
        currentSection--;
        showSection(currentSection);
    }
});

// Click en los pasos del progreso
document.querySelectorAll('.progress-step').forEach(step => {
    step.addEventListener('click', function() {
        const targetSection = parseInt(this.dataset.section);
        // Solo permitir ir a secciones anteriores o a la actual
        if (targetSection <= currentSection) {
            currentSection = targetSection;
            showSection(currentSection);
        } else {
            // Validar todas las secciones anteriores antes de avanzar
            let canAdvance = true;
            for (let i = currentSection; i < targetSection; i++) {
                if (!validateSection(i)) {
                    canAdvance = false;
                    break;
                }
            }
            if (canAdvance) {
                currentSection = targetSection;
                showSection(currentSection);
            }
        }
    });
});

// Validación final al enviar
document.getElementById('caracterizacionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validar todas las secciones
    let allValid = true;
    for (let i = 1; i <= totalSections; i++) {
        if (!validateSection(i)) {
            allValid = false;
            // Ir a la primera sección con errores
            currentSection = i;
            showSection(currentSection);
            break;
        }
    }
    
    if (allValid) {
        // Aquí puedes enviar el formulario
        alert('Formulario válido. Listo para enviar al servidor.');
        // this.submit(); // Descomentar cuando tengas el backend listo
    }
});
</script>

<style>
/* Breadcrumb */
.breadcrumb {
    margin-bottom: 32px;
}

.breadcrumb-item {
    font-size: 14px;
    color: #1a2332;
    font-weight: 500;
    font-family: 'Poppins', sans-serif;
}

/* Container */
.caracterizacion-container {
    max-width: 900px;
    margin: 0 auto;
    padding-bottom: 40px;
}

/* Progress Indicator */
.form-progress {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    margin-bottom: 48px;
    padding: 0 20px;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    flex: 0 0 auto;
}

.step-circle {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background-color: #ffffff;
    color: #9ca3af;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 700;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s ease;
    border: 3px solid #d1d5db;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
}

.progress-step.active .step-circle {
    background-color: #1a2849;
    color: white;
    border-color: #1a2849;
    box-shadow: 0 3px 10px rgba(26, 40, 73, 0.3);
}

.progress-step.completed .step-circle {
    background-color: #6cee12;
    color: white;
    border-color: #6cee12;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
}

.step-label {
    font-size: 12px;
    color: #6b7280;
    text-align: center;
    font-weight: 500;
    font-family: 'Poppins', sans-serif;
    width: 95px;
    line-height: 1.3;
    min-height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.progress-step.active .step-label {
    color: #1a2849;
    font-weight: 700;
}

.progress-step.completed .step-label {
    color: #6cee12;  /* 👈 AQUÍ cambias el color */
    font-weight: 600;
}

.progress-line {
    height: 3px;
    width: 80px;
    background-color: #d1d5db;
    transition: all 0.3s ease;
    border-radius: 2px;
    margin: 22px 10px 0 10px;
    flex-shrink: 0;
}

.progress-step.completed + .progress-line {
    background-color: #6cee12;
}

/* Form Card */
.form-card {
    background: white;
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    margin-bottom: 40px;
}

/* Form Sections */
.form-section {
    display: none;
}

.form-section.active {
    display: block;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.section-title {
    font-size: 28px;
    font-weight: 700;
    color: #1a2332;
    margin-bottom: 8px;
    font-family: 'Poppins', sans-serif;
}

.section-subtitle {
    font-size: 15px;
    color: #6b7280;
    margin-bottom: 32px;
    font-family: 'Poppins', sans-serif;
}

/* Form Rows and Groups */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-label {
    font-size: 14px;
    font-weight: 600;
    color: #1a2332;
    margin-bottom: 8px;
    font-family: 'Poppins', sans-serif;
}

.form-input,
.form-textarea {
    width: 100%;
    padding: 12px 16px;
    font-size: 15px;
    font-family: 'Poppins', sans-serif;
    border: 1.5px solid #d1d5db;
    border-radius: 10px;
    outline: none;
    transition: all 0.2s ease;
    background-color: #fafbfc;
    color: #1a2332;
}

.form-input::placeholder,
.form-textarea::placeholder {
    color: #9ca3af;
}

.form-input:focus,
.form-textarea:focus {
    border-color: #1a2849;
    background-color: #ffffff;
    box-shadow: 0 0 0 3px rgba(26, 40, 73, 0.1);
}

.form-input:hover,
.form-textarea:hover {
    border-color: #9ca3af;
}

.form-input.input-error,
.form-textarea.input-error {
    border-color: #ef4444;
    background-color: #fef2f2;
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
    line-height: 1.6;
}

/* Character Counter */
.char-counter {
    font-size: 13px;
    color: #6b7280;
    text-align: right;
    margin-top: 4px;
    font-family: 'Poppins', sans-serif;
}

.char-counter .current-chars {
    font-weight: 600;
    color: #1a2332;
}

/* Error Messages */
.error-message {
    display: none;
    font-size: 13px;
    color: #ef4444;
    margin-top: 6px;
    font-family: 'Poppins', sans-serif;
}

/* Navigation Buttons */
.form-navigation {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 40px;
    padding-top: 32px;
    border-top: 1px solid #e5e7eb;
}

.btn-navigation {
    padding: 12px 32px;
    font-size: 15px;
    font-weight: 600;
    font-family: 'Poppins', sans-serif;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-prev {
    background-color: #f3f4f6;
    color: #1a2332;
}

.btn-prev:hover {
    background-color: #e5e7eb;
}

.btn-next,
.btn-submit {
    background-color: #1a2849;
    color: white;
}

.btn-next:hover,
.btn-submit:hover {
    background-color: #0f1a33;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(26, 40, 73, 0.3);
}

/* Responsive */
@media (max-width: 768px) {
    .caracterizacion-container {
        padding-bottom: 20px;
    }

    .form-progress {
        overflow-x: auto;
        justify-content: flex-start;
        padding: 0 16px;
        margin-bottom: 32px;
    }

    .progress-step {
        min-width: 85px;
    }

    .step-circle {
        width: 40px;
        height: 40px;
        font-size: 16px;
        border-width: 2px;
    }

    .step-label {
        font-size: 11px;
        width: 80px;
        min-height: 30px;
    }

    .progress-line {
        width: 50px;
        margin: 20px 6px 0 6px;
    }

    .form-card {
        padding: 28px 20px;
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 24px;
    }

    .section-subtitle {
        font-size: 14px;
    }

    .form-row {
        grid-template-columns: 1fr;
        gap: 16px;
    }

    .form-navigation {
        flex-direction: column;
        gap: 12px;
    }

    .btn-navigation {
        width: 100%;
    }
}

@media (max-width: 480px) {
    .breadcrumb {
        margin-bottom: 20px;
    }

    .form-card {
        padding: 20px 16px;
        border-radius: 16px;
    }

    .section-title {
        font-size: 20px;
    }
}
</style>
