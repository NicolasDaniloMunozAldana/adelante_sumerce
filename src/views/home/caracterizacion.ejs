<%- include('../partials/header') %>
<link rel="stylesheet" href="/css/caracterizacion.css">
<%- include('../partials/navbar') %>

<!-- Breadcrumb -->
<div class="breadcrumb">
    <span class="breadcrumb-item">> Caracterización</span>
</div>

<div class="caracterizacion-container">
    <!-- Progress Indicator (Miga de pan de secciones) -->
    <div class="form-progress">
        <div class="progress-step active" data-section="1">
            <div class="step-circle">1</div>
            <div class="step-label">Datos Generales</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" data-section="2">
            <div class="step-circle">2</div>
            <div class="step-label">Modelo de Negocio</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" data-section="3">
            <div class="step-circle">3</div>
            <div class="step-label">Finanzas</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" data-section="4">
            <div class="step-circle">4</div>
            <div class="step-label">Equipo de Trabajo</div>
        </div>
    </div>

    <!-- Formulario Multi-sección -->
    <div class="form-card">        
        <form id="caracterizacionForm" method="POST" action="/caracterizacion/save">
            
            <!-- SECCIÓN A: Datos Generales -->
            <div class="form-section active" data-section="1">
                <h2 class="section-title">Datos Generales</h2>
                <p class="section-subtitle">Complete el formulario para crear una caracterización</p>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="nombreEmprendimiento" class="form-label">Nombre del emprendimiento</label>
                        <input 
                            type="text" 
                            id="nombreEmprendimiento" 
                            name="nombreEmprendimiento" 
                            class="form-input"
                            value="<%= existingData ? existingData.nombreEmprendimiento : '' %>"
                            <% if (isReadOnly) { %>readonly<% } %>
                            required
                        >
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="anioCreacion" class="form-label">Año de creación del emprendimiento</label>
                        <input 
                            type="number" 
                            id="anioCreacion" 
                            name="anioCreacion" 
                            class="form-input"
                            min="1900"
                            max="2025"
                            value="<%= existingData ? existingData.anioCreacion : '' %>"
                            <% if (isReadOnly) { %>readonly<% } %>
                            required
                        >
                        <span class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="sectorEconomico" class="form-label">Sector económico</label>
                        <select id="sectorEconomico" name="sectorEconomico" class="form-input" <% if (isReadOnly) { %>disabled<% } %> required>
                            <option value="">Seleccione un sector</option>
                            <option value="agricultura" <%= existingData && existingData.sectorEconomico === 'agricultura' ? 'selected' : '' %>>Agricultura, ganadería y pesca</option>
                            <option value="manufactura" <%= existingData && existingData.sectorEconomico === 'manufactura' ? 'selected' : '' %>>Manufactura</option>
                            <option value="comercio" <%= existingData && existingData.sectorEconomico === 'comercio' ? 'selected' : '' %>>Comercio</option>
                            <option value="servicios" <%= existingData && existingData.sectorEconomico === 'servicios' ? 'selected' : '' %>>Servicios</option>
                            <option value="tecnologia" <%= existingData && existingData.sectorEconomico === 'tecnologia' ? 'selected' : '' %>>Tecnología</option>
                            <option value="turismo" <%= existingData && existingData.sectorEconomico === 'turismo' ? 'selected' : '' %>>Turismo</option>
                            <option value="construccion" <%= existingData && existingData.sectorEconomico === 'construccion' ? 'selected' : '' %>>Construcción</option>
                            <option value="otro" <%= existingData && existingData.sectorEconomico === 'otro' ? 'selected' : '' %>>Otro</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="nombreEncargado" class="form-label">Nombre del encargado</label>
                        <input 
                            type="text" 
                            id="nombreEncargado" 
                            name="nombreEncargado" 
                            class="form-input"
                            value="<%= existingData ? existingData.nombreEncargado : '' %>"
                            <% if (isReadOnly) { %>readonly<% } %>
                            required
                        >
                        <span class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="celularEncargado" class="form-label">Celular</label>
                        <input 
                            type="tel" 
                            id="celularEncargado" 
                            name="celularEncargado" 
                            class="form-input"
                            placeholder="3001234567"
                            maxlength="10"
                            pattern="[3][0-9]{9}"
                            value="<%= existingData ? existingData.celularEncargado : '' %>"
                            <% if (isReadOnly) { %>readonly<% } %>
                            required
                        >
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="correoEncargado" class="form-label">Correo electrónico</label>
                        <input 
                            type="email" 
                            id="correoEncargado" 
                            name="correoEncargado" 
                            class="form-input"
                            placeholder="ejemplo@correo.com"
                            value="<%= existingData ? existingData.correoEncargado : '' %>"
                            <% if (isReadOnly) { %>readonly<% } %>
                            required
                        >
                        <span class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="tiempoOperacion" class="form-label">Tiempo de operación</label>
                        <select id="tiempoOperacion" name="tiempoOperacion" class="form-input" <% if (isReadOnly) { %>disabled<% } %> required>
                            <option value="">Seleccione una opción</option>
                            <option value="0_6_meses" <%= existingData && existingData.tiempoOperacion === '0_6_meses' ? 'selected' : '' %>>Menos de 6 meses</option>
                            <option value="6_12_meses" <%= existingData && existingData.tiempoOperacion === '6_12_meses' ? 'selected' : '' %>>6 a 12 meses</option>
                            <option value="12_24_meses" <%= existingData && existingData.tiempoOperacion === '12_24_meses' ? 'selected' : '' %>>1 a 3 años</option>
                            <option value="mas_24_meses" <%= existingData && existingData.tiempoOperacion === 'mas_24_meses' ? 'selected' : '' %>>4 años o más</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN B: Modelo de Negocio -->
            <div class="form-section" data-section="2">
                <h2 class="section-title">Modelo de Negocio</h2>
                <p class="section-subtitle">Describa los elementos clave de su modelo de negocio</p>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="propuestaValor" class="form-label">Propuesta de valor</label>
                        <textarea 
                            id="propuestaValor" 
                            name="propuestaValor" 
                            class="form-textarea"
                            maxlength="300"
                            rows="4"
                            <% if (isReadOnly) { %>readonly<% } %>
                            required
                        ><%= existingData ? existingData.propuestaValor : '' %></textarea>
                        <div class="char-counter">
                            <span class="current-chars"><%= existingData && existingData.propuestaValor ? existingData.propuestaValor.length : 0 %></span> / 300 caracteres
                        </div>
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="segmentoClientes" class="form-label">Segmento de clientes</label>
                        <textarea 
                            id="segmentoClientes" 
                            name="segmentoClientes" 
                            class="form-textarea"
                            maxlength="300"
                            rows="4"
                            <% if (isReadOnly) { %>readonly<% } %>
                            required
                        ><%= existingData ? existingData.segmentoClientes : '' %></textarea>
                        <div class="char-counter">
                            <span class="current-chars"><%= existingData && existingData.segmentoClientes ? existingData.segmentoClientes.length : 0 %></span> / 300 caracteres
                        </div>
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="canalesVenta" class="form-label">Canales de venta</label>
                        <textarea 
                            id="canalesVenta" 
                            name="canalesVenta" 
                            class="form-textarea"
                            maxlength="300"
                            rows="4"
                            <% if (isReadOnly) { %>readonly<% } %>
                            required
                        ><%= existingData ? existingData.canalesVenta : '' %></textarea>
                        <div class="char-counter">
                            <span class="current-chars"><%= existingData && existingData.canalesVenta ? existingData.canalesVenta.length : 0 %></span> / 300 caracteres
                        </div>
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="fuentesIngreso" class="form-label">Fuentes de ingreso</label>
                        <textarea 
                            id="fuentesIngreso" 
                            name="fuentesIngreso" 
                            class="form-textarea"
                            maxlength="300"
                            rows="4"
                            <% if (isReadOnly) { %>readonly<% } %>
                            required
                        ><%= existingData ? existingData.fuentesIngreso : '' %></textarea>
                        <div class="char-counter">
                            <span class="current-chars"><%= existingData && existingData.fuentesIngreso ? existingData.fuentesIngreso.length : 0 %></span> / 300 caracteres
                        </div>
                        <span class="error-message"></span>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN C: Finanzas -->
            <div class="form-section" data-section="3">
                <h2 class="section-title">Finanzas</h2>
                <p class="section-subtitle">Información financiera del emprendimiento</p>

                <div class="form-row">
                    <div class="form-group">
                        <label for="ventasNetas" class="form-label">Ventas netas promedio al mes</label>
                        <select id="ventasNetas" name="ventasNetas" class="form-input" <% if (isReadOnly) { %>disabled<% } %> required>
                            <option value="">Seleccione una opción</option>
                            <option value="menos_1_smmlv" <%= existingData && existingData.ventasNetas === 'menos_1_smmlv' ? 'selected' : '' %>>Menos de 1 SMMLV</option>
                            <option value="1_3_smmlv" <%= existingData && existingData.ventasNetas === '1_3_smmlv' ? 'selected' : '' %>>1 - 3 SMMLV</option>
                            <option value="3_mas_smmlv" <%= existingData && existingData.ventasNetas === '3_mas_smmlv' ? 'selected' : '' %>>3 o más SMMLV</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="rentabilidad" class="form-label">Rentabilidad mensual aproximada</label>
                        <select id="rentabilidad" name="rentabilidad" class="form-input" <% if (isReadOnly) { %>disabled<% } %> required>
                            <option value="">Seleccione una opción</option>
                            <option value="menos_medio_smmlv" <%= existingData && existingData.rentabilidad === 'menos_medio_smmlv' ? 'selected' : '' %>>Menos de ½ SMMLV</option>
                            <option value="medio_1_smmlv" <%= existingData && existingData.rentabilidad === 'medio_1_smmlv' ? 'selected' : '' %>>½ y 1 SMMLV</option>
                            <option value="2_mas_smmlv" <%= existingData && existingData.rentabilidad === '2_mas_smmlv' ? 'selected' : '' %>>2 o más SMMLV</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fuentesFinanciamiento" class="form-label">Fuentes de financiamiento</label>
                        <select id="fuentesFinanciamiento" name="fuentesFinanciamiento" class="form-input" <% if (isReadOnly) { %>disabled<% } %> required>
                            <option value="">Seleccione una opción</option>
                            <option value="recursos_propios" <%= existingData && existingData.fuentesFinanciamiento === 'recursos_propios' ? 'selected' : '' %>>Recursos propios</option>
                            <option value="credito_bancario" <%= existingData && existingData.fuentesFinanciamiento === 'credito_bancario' ? 'selected' : '' %>>Crédito bancario</option>
                            <option value="inversionistas" <%= existingData && existingData.fuentesFinanciamiento === 'inversionistas' ? 'selected' : '' %>>Inversionistas</option>
                            <option value="subsidios" <%= existingData && existingData.fuentesFinanciamiento === 'subsidios' ? 'selected' : '' %>>Subsidios gubernamentales</option>
                            <option value="mixto" <%= existingData && existingData.fuentesFinanciamiento === 'mixto' ? 'selected' : '' %>>Mixto</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="costosFijos" class="form-label">Costos fijos mensuales</label>
                        <select id="costosFijos" name="costosFijos" class="form-input" <% if (isReadOnly) { %>disabled<% } %> required>
                            <option value="">Seleccione una opción</option>
                            <option value="menos_medio_smmlv" <%= existingData && existingData.costosFijos === 'menos_medio_smmlv' ? 'selected' : '' %>>Menos de ½ SMMLV</option>
                            <option value="medio_1_smmlv" <%= existingData && existingData.costosFijos === 'medio_1_smmlv' ? 'selected' : '' %>>½ y 1 SMMLV</option>
                            <option value="2_mas_smmlv" <%= existingData && existingData.costosFijos === '2_mas_smmlv' ? 'selected' : '' %>>2 o más SMMLV</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN D: Equipo de Trabajo -->
            <div class="form-section" data-section="4">
                <h2 class="section-title">Equipo de Trabajo</h2>
                <p class="section-subtitle">Información sobre el equipo y su capacitación</p>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="formacionEmpresarial" class="form-label">Nivel de formación empresarial</label>
                        <select id="formacionEmpresarial" name="formacionEmpresarial" class="form-input" <% if (isReadOnly) { %>disabled<% } %> required>
                            <option value="">Seleccione una opción</option>
                            <option value="sin_formacion" <%= existingData && existingData.formacionEmpresarial === 'sin_formacion' ? 'selected' : '' %>>Sin formación empresarial</option>
                            <option value="tecnica_profesional" <%= existingData && existingData.formacionEmpresarial === 'tecnica_profesional' ? 'selected' : '' %>>Con formación técnica/profesional</option>
                            <option value="administracion_emprendimiento" <%= existingData && existingData.formacionEmpresarial === 'administracion_emprendimiento' ? 'selected' : '' %>>Con formación en administración/emprendimiento</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="personalCapacitado" class="form-label">¿Personal capacitado?</label>
                        <select id="personalCapacitado" name="personalCapacitado" class="form-input" <% if (isReadOnly) { %>disabled<% } %> required>
                            <option value="">Seleccione una opción</option>
                            <option value="si" <%= existingData && existingData.personalCapacitado === 'si' ? 'selected' : '' %>>Sí</option>
                            <option value="no" <%= existingData && existingData.personalCapacitado === 'no' ? 'selected' : '' %>>No</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="rolesDefinidos" class="form-label">¿Roles definidos en el emprendimiento?</label>
                        <select id="rolesDefinidos" name="rolesDefinidos" class="form-input" <% if (isReadOnly) { %>disabled<% } %> required>
                            <option value="">Seleccione una opción</option>
                            <option value="si" <%= existingData && existingData.rolesDefinidos === 'si' ? 'selected' : '' %>>Sí</option>
                            <option value="no" <%= existingData && existingData.rolesDefinidos === 'no' ? 'selected' : '' %>>No</option>
                        </select>
                        <span class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="cantidadEmpleados" class="form-label">Cantidad de empleados</label>
                        <input 
                            type="number" 
                            id="cantidadEmpleados" 
                            name="cantidadEmpleados" 
                            class="form-input"
                            min="0"
                            value="<%= existingData ? existingData.cantidadEmpleados : '' %>"
                            <% if (isReadOnly) { %>readonly<% } %>
                            required
                        >
                        <span class="error-message"></span>
                    </div>
                </div>
            </div>

            <!-- Botones de Navegación -->
            <div class="form-navigation">
                <button type="button" class="btn-navigation btn-prev" id="btnPrev" style="display: none;">
                    Anterior
                </button>
                <button type="button" class="btn-navigation btn-next" id="btnNext">
                    Siguiente
                </button>
                <% if (!isReadOnly) { %>
                <button type="submit" class="btn-navigation btn-submit" id="btnSubmit" style="display: none;">
                    Enviar Información
                </button>
                <% } %>
            </div>
        </form>
    </div>
</div>

<%- include('../partials/footer') %>

<script>
// Estado del formulario
let currentSection = 1;
const totalSections = 4;
const isReadOnly = <%= isReadOnly ? 'true' : 'false' %>;

// Actualizar contadores de caracteres
document.querySelectorAll('.form-textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
        const counter = this.parentElement.querySelector('.current-chars');
        if (counter) {
            counter.textContent = this.value.length;
        }
    });
});

// Solo aplicar validaciones si NO está en modo de solo lectura
if (!isReadOnly) {
    // Validación de celular (solo números y que empiece con 3)
    document.getElementById('celularEncargado').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
        if (this.value.length > 0 && this.value[0] !== '3') {
            showError(this, 'El celular debe comenzar con 3');
        } else if (this.value.length > 0 && this.value.length < 10) {
            showError(this, 'El celular debe tener 10 dígitos');
        } else {
            clearError(this);
        }
    });

    // Validación de año
    document.getElementById('anioCreacion').addEventListener('input', function(e) {
        const year = parseInt(this.value);
        if (year < 1900) {
            this.value = 1900;
        } else if (year > 2025) {
            this.value = 2025;
        }
        // No permitir números negativos
        if (this.value < 0) {
            this.value = Math.abs(this.value);
        }
    });
}

// Funciones de validación
function showError(input, message) {
    const errorSpan = input.parentElement.querySelector('.error-message');
    if (errorSpan) {
        errorSpan.textContent = message;
        errorSpan.style.display = 'block';
    }
    input.classList.add('input-error');
}

function clearError(input) {
    const errorSpan = input.parentElement.querySelector('.error-message');
    if (errorSpan) {
        errorSpan.textContent = '';
        errorSpan.style.display = 'none';
    }
    input.classList.remove('input-error');
}

function validateSection(sectionNumber) {
    const section = document.querySelector(`.form-section[data-section="${sectionNumber}"]`);
    const inputs = section.querySelectorAll('input[required], select[required], textarea[required]');
    let isValid = true;

    inputs.forEach(input => {
        clearError(input);
        
        if (!input.value.trim()) {
            showError(input, 'Este campo es obligatorio');
            isValid = false;
        } else {
            // Validaciones específicas
            if (input.type === 'email' && !isValidEmail(input.value)) {
                showError(input, 'Correo electrónico inválido');
                isValid = false;
            }
            
            if (input.type === 'tel' && input.value.length !== 10) {
                showError(input, 'El celular debe tener 10 dígitos');
                isValid = false;
            }
            
            if (input.type === 'tel' && !input.value.startsWith('3')) {
                showError(input, 'El celular debe comenzar con 3');
                isValid = false;
            }
        }
    });

    return isValid;
}

function isValidEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

function showSection(sectionNumber) {
    // Ocultar todas las secciones
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Mostrar sección actual
    const currentSectionEl = document.querySelector(`.form-section[data-section="${sectionNumber}"]`);
    if (currentSectionEl) {
        currentSectionEl.classList.add('active');
    }
    
    // Actualizar indicador de progreso
    document.querySelectorAll('.progress-step').forEach(step => {
        const stepSection = parseInt(step.dataset.section);
        step.classList.remove('active', 'completed');
        
        if (stepSection === sectionNumber) {
            step.classList.add('active');
        } else if (stepSection < sectionNumber) {
            step.classList.add('completed');
        }
    });
    
    // Actualizar botones
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnSubmit = document.getElementById('btnSubmit');
    
    btnPrev.style.display = sectionNumber === 1 ? 'none' : 'inline-block';
    btnNext.style.display = sectionNumber === totalSections ? 'none' : 'inline-block';
    btnSubmit.style.display = sectionNumber === totalSections ? 'inline-block' : 'none';
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Event listeners para navegación
document.getElementById('btnNext').addEventListener('click', function() {
    if (validateSection(currentSection)) {
        if (currentSection < totalSections) {
            currentSection++;
            showSection(currentSection);
        }
    }
});

document.getElementById('btnPrev').addEventListener('click', function() {
    if (currentSection > 1) {
        currentSection--;
        showSection(currentSection);
    }
});

// Click en los pasos del progreso
document.querySelectorAll('.progress-step').forEach(step => {
    step.addEventListener('click', function() {
        const targetSection = parseInt(this.dataset.section);
        // Solo permitir ir a secciones anteriores o a la actual
        if (targetSection <= currentSection) {
            currentSection = targetSection;
            showSection(currentSection);
        } else {
            // Validar todas las secciones anteriores antes de avanzar
            let canAdvance = true;
            for (let i = currentSection; i < targetSection; i++) {
                if (!validateSection(i)) {
                    canAdvance = false;
                    break;
                }
            }
            if (canAdvance) {
                currentSection = targetSection;
                showSection(currentSection);
            }
        }
    });
});

// Validación final al enviar
document.getElementById('caracterizacionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Si está en modo de solo lectura, no permitir el envío
    if (isReadOnly) {
        alert('Este formulario está en modo de solo lectura. No se pueden realizar cambios.');
        return;
    }
    
    // Validar todas las secciones
    let allValid = true;
    for (let i = 1; i <= totalSections; i++) {
        if (!validateSection(i)) {
            allValid = false;
            // Ir a la primera sección con errores
            currentSection = i;
            showSection(currentSection);
            break;
        }
    }
    
    if (allValid) {
        // Recoger todos los datos del formulario
        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => {
            data[key] = value;
        });

        // Enviar datos al servidor
        fetch('/caracterizacion/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('¡Caracterización guardada exitosamente!');
                // Redirigir a la página de resultados
                window.location.href = `/dashboard`;
            } else {
                alert('Error al guardar la caracterización: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al guardar la caracterización. Por favor, intente nuevamente.');
        });
    }
});
</script>