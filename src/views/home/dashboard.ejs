<%- include('../partials/header') %>
    <link rel="stylesheet" href="/css/dashboard.css">
    <%- include('../partials/navbar') %>

        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <span class="breadcrumb-item">> Dashboard</span>
        </div>

        <div class="dashboard-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h1 class="dashboard-title">Dashboard del Emprendimiento</h1>
                    <p class="dashboard-subtitle">
                        Visualiza el estado y progreso de tu emprendimiento basado en la caracterizaci贸n.
                    </p>
                </div>
                <% if (typeof caracterizacion !=="undefined" && caracterizacion) { %>
                <button id="btnGenerarPDF" class="btn-generar-pdf">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Generar Reporte PDF
                </button>
                <% } %>
            </div>

            <!-- Secci贸n protegida: si caracterizacion no existe, muestra mensaje -->
            <% if (typeof caracterizacion !=="undefined" && caracterizacion) { %>

                <!-- Consolidado General -->
                <div class="dashboard-summary">
                    <h2>Resumen General</h2>
                    <div class="summary-card">
                        <div class="summary-item">
                            <div class="summary-icon"></div>
                            <p class="summary-label">Puntaje total</p>
                            <p class="summary-value">
                                <%= caracterizacion.puntajeTotal %> / <%= caracterizacion.maxTotal %>
                            </p>
                        </div>
                        <div class="summary-item">
                            <div class="summary-icon"></div>
                            <p class="summary-label">Porcentaje</p>
                            <p class="summary-value">
                                <%= caracterizacion.porcentaje %>%
                            </p>
                        </div>
                        <div class="summary-item">
                            <div class="summary-icon"></div>
                            <p class="summary-label">Clasificaci贸n</p>
                            <p class="summary-value status-<%= caracterizacion.estado.toLowerCase().replace(' ', '-') %>">
                                <%= caracterizacion.estado %>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Grid Layout para gr谩fico y progreso -->
                <div class="dashboard-grid">
                    <!-- Gr谩fica de Pastel -->
                    <div class="chart-section">
                        <h3>Desempe帽o por Dimensi贸n</h3>
                        <div class="chart-container">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>

                    <!-- Barra de Progreso y Estad铆sticas -->
                    <div class="progress-section">
                        <h3>Nivel de Consolidaci贸n</h3>
                        <div class="progress-wrapper">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill">
                                    <span><%= caracterizacion.porcentaje %>%</span>
                                </div>
                            </div>
                            <div class="progress-stats">
                                <div class="stat-item">
                                    <span class="stat-number"><%= caracterizacion.secciones.length %></span>
                                    <span class="stat-label">Secciones</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number"><%= Math.round(caracterizacion.secciones.reduce((acc, s) => acc + s.porcentaje, 0) / caracterizacion.secciones.length) %>%</span>
                                    <span class="stat-label">Promedio</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Puntajes -->
                <div class="table-section">
                    <h3>Detalle por Secci贸n</h3>
                    <div class="table-wrapper">
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th>Secci贸n</th>
                                    <th>Puntaje</th>
                                    <th>Porcentaje</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% caracterizacion.secciones.forEach(sec=> { %>
                                    <tr>
                                        <td class="section-name">
                                            <span class="section-indicator section-color-<%= caracterizacion.secciones.indexOf(sec) % 7 %>"></span>
                                            <%= sec.nombre %>
                                        </td>
                                        <td class="score-value">
                                            <%= sec.puntaje %>
                                        </td>
                                        <td class="percentage-value">
                                            <div class="mini-progress">
                                                <div class="mini-progress-fill" data-width="<%= sec.porcentaje %>"></div>
                                            </div>
                                            <%= sec.porcentaje %>%
                                        </td>
                                        <td class="status-value">
                                            <span class="status-badge <%= sec.porcentaje >= 80 ? 'status-excellent' : sec.porcentaje >= 60 ? 'status-good' : sec.porcentaje >= 40 ? 'status-fair' : 'status-poor' %>">
                                                <%= sec.porcentaje >= 80 ? 'Excelente' : sec.porcentaje >= 60 ? 'Bueno' : sec.porcentaje >= 40 ? 'Regular' : 'Necesita mejora' %>
                                            </span>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>

                <% } else { %>
                    <!--  Mensaje de error claro si caracterizacion no fue pasada -->
                    <div class="alert alert-warning">
                        <p>No hay datos de caracterizaci贸n disponibles.</p>
                        <p>Por favor, complete la caracterizaci贸n primero.</p>
                    </div>
                    <% } %>
        </div>

        <%- include('../partials/footer') %>

            <%- include('../partials/footer') %>

                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <% if (typeof caracterizacion !== "undefined" && caracterizacion) { %>
                <script id="caracterizacion-data" type="application/json"><%- JSON.stringify(caracterizacion) %></script>
                <% } %>

                <script>
                (function(){
                  const dataScript = document.getElementById('caracterizacion-data');
                  if (!dataScript) return; // no hay datos para graficar
                  const caracterizacion = JSON.parse(dataScript.textContent);

                  // Funci贸n para animar elementos con delay
                  const animateWithDelay = (callback, delay = 500) => {
                    setTimeout(callback, delay);
                  };

                  // Actualizar barra de progreso principal
                  const fill = document.getElementById('progressFill');
                  if (fill && typeof caracterizacion.porcentaje === 'number') {
                    animateWithDelay(() => {
                      fill.style.width = `${caracterizacion.porcentaje}%`;
                    }, 800);
                  }

                  // Actualizar barras de progreso mini en la tabla
                  const miniProgressBars = document.querySelectorAll('.mini-progress-fill');
                  miniProgressBars.forEach((bar, index) => {
                    const width = bar.getAttribute('data-width');
                    if (width) {
                      animateWithDelay(() => {
                        bar.style.width = `${width}%`;
                      }, 1000 + (index * 100));
                    }
                  });

                  // Gr谩fico de pastel mejorado
                  const ctx = document.getElementById('radarChart');
                  if (!ctx) return;
                  const labels = caracterizacion.secciones.map(s => s.nombre);
                  const values = caracterizacion.secciones.map(s => (
                    typeof s.porcentaje === 'number' ? s.porcentaje : Math.round((s.puntaje / (s.max || 1)) * 100)
                  ));
                  const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#84cc16'];

                  new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                      labels,
                      datasets: [{
                        label: 'Porcentaje por Secci贸n',
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 3,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 4,
                        hoverBorderColor: '#ffffff'
                      }]
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: true,
                      cutout: '60%',
                      plugins: {
                        legend: { 
                          position: 'bottom',
                          labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                              size: 12,
                              family: 'Poppins'
                            }
                          }
                        },
                        tooltip: { 
                          backgroundColor: 'rgba(0, 0, 0, 0.8)',
                          titleColor: '#ffffff',
                          bodyColor: '#ffffff',
                          borderColor: '#ffffff',
                          borderWidth: 1,
                          callbacks: { 
                            label: (ctx) => `${ctx.label}: ${ctx.parsed}%` 
                          }
                        }
                      },
                      animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 1500,
                        easing: 'easeInOutCubic'
                      },
                      elements: {
                        arc: {
                          borderJoinStyle: 'round'
                        }
                      }
                    }
                  });
                })();
                </script>
          
                
                <script>
                    // Funci贸n para generar el PDF
                    document.addEventListener('DOMContentLoaded', function() {
                        const btnGenerarPDF = document.getElementById('btnGenerarPDF');
                        
                        if (btnGenerarPDF) {
                            btnGenerarPDF.addEventListener('click', async function() {
                                const originalHTML = this.innerHTML;
                                
                                try {
                                    // Deshabilitar bot贸n y mostrar loading
                                    this.disabled = true;
                                    this.classList.add('loading');
                                    this.innerHTML = `
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <path d="M12 6v6l4 2"></path>
                                        </svg>
                                        Generando PDF...
                                    `;

                                    // Realizar la petici贸n
                                    const response = await fetch('/reportes/generate-pdf');
                                    
                                    if (!response.ok) {
                                        throw new Error('Error al generar el reporte');
                                    }

                                    // Obtener el blob del PDF
                                    const blob = await response.blob();
                                    
                                    // Crear un enlace temporal y descargarlo
                                    const url = window.URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = `reporte-caracterizacion-${new Date().getTime()}.pdf`;
                                    document.body.appendChild(a);
                                    a.click();
                                    
                                    // Limpiar
                                    window.URL.revokeObjectURL(url);
                                    document.body.removeChild(a);

                                    // Mostrar mensaje de 茅xito
                                    this.innerHTML = `
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                        隆Descargado!
                                    `;

                                    setTimeout(() => {
                                        this.innerHTML = originalHTML;
                                        this.disabled = false;
                                        this.classList.remove('loading');
                                    }, 2000);

                                } catch (error) {
                                    console.error('Error:', error);
                                    
                                    // Mostrar mensaje de error
                                    this.innerHTML = `
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="15" y1="9" x2="9" y2="15"></line>
                                            <line x1="9" y1="9" x2="15" y2="15"></line>
                                        </svg>
                                        Error al generar
                                    `;

                                    setTimeout(() => {
                                        this.innerHTML = originalHTML;
                                        this.disabled = false;
                                        this.classList.remove('loading');
                                    }, 2000);

                                    alert('Error al generar el reporte. Por favor, intenta nuevamente.');
                                }
                            });
                        }
                    });
                </script>