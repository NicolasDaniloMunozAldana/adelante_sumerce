<%- include('../partials/header') %>
    <link rel="stylesheet" href="/css/dashboard.css">
    <%- include('../partials/navbar') %>

        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <span class="breadcrumb-item">> Dashboard</span>
        </div>

        <div class="dashboard-container">
            <h1 class="dashboard-title">Dashboard del Emprendimiento</h1>
            <p class="dashboard-subtitle">
                Visualiza el estado y progreso de tu emprendimiento basado en la caracterizaci√≥n.
            </p>

            <!-- ‚úÖ Secci√≥n protegida: si caracterizacion no existe, muestra mensaje -->
            <% if (typeof caracterizacion !=="undefined" && caracterizacion) { %>

                <!-- Consolidado General -->
                <div class="dashboard-summary">
                    <h2>Resumen General</h2>
                    <div class="summary-card">
                        <div class="summary-item">
                            <div class="summary-icon"></div>
                            <p class="summary-label">Puntaje total</p>
                            <p class="summary-value">
                                <%= caracterizacion.puntajeTotal %> / <%= caracterizacion.maxTotal %>
                            </p>
                        </div>
                        <div class="summary-item">
                            <div class="summary-icon"></div>
                            <p class="summary-label">Porcentaje</p>
                            <p class="summary-value">
                                <%= caracterizacion.porcentaje %>%
                            </p>
                        </div>
                        <div class="summary-item">
                            <div class="summary-icon"></div>
                            <p class="summary-label">Clasificaci√≥n</p>
                            <p class="summary-value status-<%= caracterizacion.estado.toLowerCase().replace(' ', '-') %>">
                                <%= caracterizacion.estado %>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Grid Layout para gr√°fico y progreso -->
                <div class="dashboard-grid">
                    <!-- Gr√°fica de Pastel -->
                    <div class="chart-section">
                        <h3>Desempe√±o por Dimensi√≥n</h3>
                        <div class="chart-container">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>

                    <!-- Barra de Progreso y Estad√≠sticas -->
                    <div class="progress-section">
                        <h3>Nivel de Consolidaci√≥n</h3>
                        <div class="progress-wrapper">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill">
                                    <span><%= caracterizacion.porcentaje %>%</span>
                                </div>
                            </div>
                            <div class="progress-stats">
                                <div class="stat-item">
                                    <span class="stat-number"><%= caracterizacion.secciones.length %></span>
                                    <span class="stat-label">Secciones</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number"><%= Math.round(caracterizacion.secciones.reduce((acc, s) => acc + s.porcentaje, 0) / caracterizacion.secciones.length) %>%</span>
                                    <span class="stat-label">Promedio</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Puntajes -->
                <div class="table-section">
                    <h3>Detalle por Secci√≥n</h3>
                    <div class="table-wrapper">
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th>Secci√≥n</th>
                                    <th>Puntaje</th>
                                    <th>Porcentaje</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% caracterizacion.secciones.forEach(sec=> { %>
                                    <tr>
                                        <td class="section-name">
                                            <span class="section-indicator section-color-<%= caracterizacion.secciones.indexOf(sec) % 7 %>"></span>
                                            <%= sec.nombre %>
                                        </td>
                                        <td class="score-value">
                                            <%= sec.puntaje %>
                                        </td>
                                        <td class="percentage-value">
                                            <div class="mini-progress">
                                                <div class="mini-progress-fill" data-width="<%= sec.porcentaje %>"></div>
                                            </div>
                                            <%= sec.porcentaje %>%
                                        </td>
                                        <td>
                                            <span class="status-badge <%= sec.porcentaje >= 80 ? 'status-excellent' : sec.porcentaje >= 60 ? 'status-good' : sec.porcentaje >= 40 ? 'status-fair' : 'status-poor' %>">
                                                <%= sec.porcentaje >= 80 ? 'Excelente' : sec.porcentaje >= 60 ? 'Bueno' : sec.porcentaje >= 40 ? 'Regular' : 'Necesita mejora' %>
                                            </span>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>

                <% } else { %>
                    <!-- üü• Mensaje de error claro si caracterizacion no fue pasada -->
                    <div class="alert alert-warning">
                        <p>No hay datos de caracterizaci√≥n disponibles.</p>
                        <p>Por favor, complete la caracterizaci√≥n primero.</p>
                    </div>
                    <% } %>
        </div>

        <%- include('../partials/footer') %>

            <%- include('../partials/footer') %>

                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <% if (typeof caracterizacion !== "undefined" && caracterizacion) { %>
                <script id="caracterizacion-data" type="application/json"><%- JSON.stringify(caracterizacion) %></script>
                <% } %>

                <script>
                (function(){
                  const dataScript = document.getElementById('caracterizacion-data');
                  if (!dataScript) return; // no hay datos para graficar
                  const caracterizacion = JSON.parse(dataScript.textContent);

                  // Funci√≥n para animar elementos con delay
                  const animateWithDelay = (callback, delay = 500) => {
                    setTimeout(callback, delay);
                  };

                  // Actualizar barra de progreso principal
                  const fill = document.getElementById('progressFill');
                  if (fill && typeof caracterizacion.porcentaje === 'number') {
                    animateWithDelay(() => {
                      fill.style.width = `${caracterizacion.porcentaje}%`;
                    }, 800);
                  }

                  // Actualizar barras de progreso mini en la tabla
                  const miniProgressBars = document.querySelectorAll('.mini-progress-fill');
                  miniProgressBars.forEach((bar, index) => {
                    const width = bar.getAttribute('data-width');
                    if (width) {
                      animateWithDelay(() => {
                        bar.style.width = `${width}%`;
                      }, 1000 + (index * 100));
                    }
                  });

                  // Gr√°fico de pastel mejorado
                  const ctx = document.getElementById('radarChart');
                  if (!ctx) return;
                  const labels = caracterizacion.secciones.map(s => s.nombre);
                  const values = caracterizacion.secciones.map(s => (
                    typeof s.porcentaje === 'number' ? s.porcentaje : Math.round((s.puntaje / (s.max || 1)) * 100)
                  ));
                  const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#84cc16'];

                  new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                      labels,
                      datasets: [{
                        label: 'Porcentaje por Secci√≥n',
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 3,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 4,
                        hoverBorderColor: '#ffffff'
                      }]
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: true,
                      cutout: '60%',
                      plugins: {
                        legend: { 
                          position: 'bottom',
                          labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                              size: 12,
                              family: 'Poppins'
                            }
                          }
                        },
                        tooltip: { 
                          backgroundColor: 'rgba(0, 0, 0, 0.8)',
                          titleColor: '#ffffff',
                          bodyColor: '#ffffff',
                          borderColor: '#ffffff',
                          borderWidth: 1,
                          callbacks: { 
                            label: (ctx) => `${ctx.label}: ${ctx.parsed}%` 
                          }
                        }
                      },
                      animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 1500,
                        easing: 'easeInOutCubic'
                      },
                      elements: {
                        arc: {
                          borderJoinStyle: 'round'
                        }
                      }
                    }
                  });
                })();
                </script>
                <style>
                    .dashboard-container {
                        max-width: 1200px;
                        margin: 0 auto;
                        background: #fff;
                        border-radius: 16px;
                        padding: 32px;
                        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
                        font-family: 'Poppins', sans-serif;
                    }

                    .dashboard-title {
                        font-size: 30px;
                        color: #1a2332;
                        margin-bottom: 8px;
                        text-align: center;
                    }

                    .dashboard-subtitle {
                        color: #4b5563;
                        margin-bottom: 32px;
                        text-align: center;
                        font-size: 16px;
                    }

                    /* Resumen General Mejorado */
                    .dashboard-summary {
                        margin-bottom: 32px;
                    }

                    .dashboard-summary h2 {
                        color: #1a2332;
                        margin-bottom: 20px;
                        font-size: 24px;
                        text-align: center;
                    }

                    .summary-card {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 20px;
                        margin-bottom: 32px;
                    }

                    .summary-item {
                        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                        border-radius: 16px;
                        padding: 24px;
                        text-align: center;
                        border: 1px solid #e2e8f0;
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                    }

                    .summary-item:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
                    }

                    .summary-icon {
                        font-size: 32px;
                        margin-bottom: 12px;
                    }

                    .summary-label {
                        font-weight: 500;
                        color: #6b7280;
                        margin: 8px 0;
                        font-size: 14px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }

                    .summary-value {
                        font-size: 24px;
                        font-weight: 700;
                        color: #111827;
                        margin: 0;
                    }

                    /* Status Colors */
                    .status-idea-inicial {
                        color: #ef4444;
                    }

                    .status-en-desarrollo {
                        color: #f59e0b;
                    }

                    .status-consolidado {
                        color: #10b981;
                    }

                    /* Grid Layout para gr√°fico y progreso */
                    .dashboard-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 32px;
                        margin-bottom: 32px;
                    }

                    @media (max-width: 768px) {
                        .dashboard-grid {
                            grid-template-columns: 1fr;
                        }
                    }

                    /* Chart Section Mejorada */
                    .chart-section {
                        background: #f9fafb;
                        border-radius: 16px;
                        padding: 24px;
                        border: 1px solid #e5e7eb;
                    }

                    .chart-section h3 {
                        color: #1a2332;
                        margin-bottom: 20px;
                        font-size: 18px;
                        text-align: center;
                    }

                    .chart-container {
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        height: 300px;
                        padding: 10px;
                    }

                    .chart-container canvas {
                        max-height: 280px !important;
                        max-width: 280px !important;
                    }

                    /* Progress Section Mejorada */
                    .progress-section {
                        background: #f9fafb;
                        border-radius: 16px;
                        padding: 24px;
                        border: 1px solid #e5e7eb;
                        display: flex;
                        flex-direction: column;
                    }

                    .progress-section h3 {
                        color: #1a2332;
                        margin-bottom: 20px;
                        font-size: 18px;
                        text-align: center;
                    }

                    .progress-wrapper {
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                    }

                    .progress-bar {
                        width: 100%;
                        background: #e5e7eb;
                        border-radius: 12px;
                        height: 28px;
                        overflow: hidden;
                        margin-bottom: 24px;
                        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
                    }

                    .progress-fill {
                        background: linear-gradient(90deg, #3b82f6, #2563eb);
                        height: 100%;
                        color: white;
                        display: flex;
                        align-items: center;
                        justify-content: flex-end;
                        font-size: 14px;
                        font-weight: 600;
                        padding-right: 12px;
                        border-radius: 12px;
                        transition: width 0.8s ease;
                        min-width: fit-content;
                    }

                    .progress-stats {
                        display: flex;
                        justify-content: space-around;
                        margin-top: 16px;
                    }

                    .stat-item {
                        text-align: center;
                    }

                    .stat-number {
                        display: block;
                        font-size: 28px;
                        font-weight: 700;
                        color: #3b82f6;
                        line-height: 1;
                    }

                    .stat-label {
                        font-size: 12px;
                        color: #6b7280;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        margin-top: 4px;
                    }

                    /* Table Section Mejorada */
                    .table-section {
                        margin-top: 32px;
                    }

                    .table-section h3 {
                        color: #1a2332;
                        margin-bottom: 20px;
                        font-size: 20px;
                    }

                    .table-wrapper {
                        background: #fff;
                        border-radius: 12px;
                        overflow: hidden;
                        border: 1px solid #e5e7eb;
                        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                    }

                    .score-table {
                        width: 100%;
                        border-collapse: collapse;
                    }

                    .score-table th {
                        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                        font-weight: 600;
                        color: #374151;
                        padding: 16px 20px;
                        text-align: left;
                        border-bottom: 2px solid #e5e7eb;
                        font-size: 14px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }

                    .score-table td {
                        padding: 16px 20px;
                        border-bottom: 1px solid #f3f4f6;
                        vertical-align: middle;
                    }

                    .score-table tr:hover {
                        background-color: #f9fafb;
                    }

                    .section-name {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        font-weight: 500;
                    }

                    .section-indicator {
                        width: 12px;
                        height: 12px;
                        border-radius: 50%;
                        flex-shrink: 0;
                    }

                    .score-value {
                        font-weight: 600;
                        color: #374151;
                        text-align: center;
                    }

                    .percentage-value {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        font-weight: 600;
                    }

                    .mini-progress {
                        width: 60px;
                        height: 6px;
                        background: #e5e7eb;
                        border-radius: 3px;
                        overflow: hidden;
                    }

                    .mini-progress-fill {
                        height: 100%;
                        background: linear-gradient(90deg, #3b82f6, #10b981);
                        border-radius: 3px;
                        transition: width 0.5s ease;
                    }

                    .status-badge {
                        padding: 6px 12px;
                        border-radius: 20px;
                        font-size: 12px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }

                    .status-excellent {
                        background: #dcfce7;
                        color: #166534;
                    }

                    .status-good {
                        background: #dbeafe;
                        color: #1e40af;
                    }

                    .status-fair {
                        background: #fef3c7;
                        color: #92400e;
                    }

                    .status-poor {
                        background: #fecaca;
                        color: #991b1b;
                    }

                    .alert {
                        background: #fff8e1;
                        border-left: 4px solid #f59e0b;
                        padding: 20px;
                        border-radius: 8px;
                        margin: 20px 0;
                        text-align: center;
                    }

                    .alert p {
                        margin: 8px 0;
                        color: #92400e;
                    }

                    /* Colores para indicadores de secci√≥n */
                    .section-color-0 { background-color: #3b82f6; }
                    .section-color-1 { background-color: #10b981; }
                    .section-color-2 { background-color: #f59e0b; }
                    .section-color-3 { background-color: #ef4444; }
                    .section-color-4 { background-color: #8b5cf6; }
                    .section-color-5 { background-color: #06b6d4; }
                    .section-color-6 { background-color: #84cc16; }
                </style>